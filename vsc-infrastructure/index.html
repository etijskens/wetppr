<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">
        <title>VSC infrastructure - Parallel Programming</title>
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/color-brewer.min.css">
        <link href="../assets/_mkdocstrings.css" rel="stylesheet">

        <script src="../js/jquery-1.10.2.min.js" defer></script>
        <script src="../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="..">Parallel Programming</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href=".." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../glossary/" class="nav-link">Glossary</a>
                            </li>
                            <li class="navitem">
                                <a href="../links/" class="nav-link">Useful links</a>
                            </li>
                            <li class="navitem">
                                <a href="../overview/" class="nav-link">Overview</a>
                            </li>
                            <li class="navitem">
                                <a href="../course-text/" class="nav-link">Course text</a>
                            </li>
                            <li class="navitem">
                                <a href="../exercises/" class="nav-link">Exercises</a>
                            </li>
                            <li class="navitem">
                                <a href="../evaluation/" class="nav-link">Evaluation of this course</a>
                            </li>
                            <li class="navitem active">
                                <a href="./" class="nav-link">VSC infrastructure</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../evaluation/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" class="nav-link disabled">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#vsc-infrastructure" class="nav-link">VSC infrastructure</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#a-bit-of-terminology" class="nav-link">A bit of terminology</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#preparing-for-the-vsc-infrastructure-in-2000wetppr" class="nav-link">Preparing for the VSC infrastructure in 2000WETPPR</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#submitting-jobs-on-vaughan" class="nav-link">Submitting jobs on Vaughan</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
            
            <li class="nav-item" data-level="1"><a href="#recommended-steps-from-here" class="nav-link">Recommended steps from here</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<div><h1 id="vsc-infrastructure">VSC infrastructure</h1>
<p>This document describes how to set up your environment for the <a href="../evaluation/">project work of the 2000wetppr course</a>
on the Tier-2 cluster of the University of Antwerp, which is also a VSC cluster. With minor modifications this can
be applied to all VSC clusters. In general, the text is also applicable to other HPC clusters, but the modifictions
needed may be a bit more substantial.</p>
<div class="admonition note">
<p class="admonition-title">Note for students</p>
<p>These topics are logically ordered. Make sure that you carry out <strong><em>all</em></strong> the tasks in the order described.</p>
</div>
<h2 id="a-bit-of-terminology">A bit of terminology</h2>
<p>In this course we often use the terms <em>local</em> and <em>remote</em>. The term <strong>local</strong> refers to the physical machine you are
working on, <em>i.e.</em> your desktop or laptop, or even a tablet or cell phone. On the other hand <strong>remote</strong> refers to a machine which is usually in some other place, and which you are accessing from your local machine through a network connection (usually the internet) with the remote machine. In this course the remote machine is the university's Tier-2 supercomputer, <em>Vaughan</em>, at the time of writing. </p>
<p><img alt="local-remote" src="../public/local-remote.png"></p>
<p>The supercomputer, basically, consists of:</p>
<ul>
<li>
<p>One or more <strong>login nodes</strong>. When users logs in to the supercomputer, a connection is established between the user's local machine and a login node. This is where users execute simple, not computationally intensive tasks, <em>e.g.</em>:</p>
<ul>
<li>
<p>job preparation,</p>
</li>
<li>
<p>organization of the workspace and projects,</p>
</li>
<li>
<p>create input data,</p>
</li>
<li>
<p>software development tasks,</p>
</li>
<li>
<p>small tests,</p>
</li>
<li>
<p>...</p>
</li>
</ul>
</li>
<li>
<p>A collection of <strong>compute nodes</strong>, potentially many thousands. This is where computationally intensive tasks of the users are executed. Typically, the user has no direct connection to the compute nodes.</p>
</li>
<li>
<p>One or more <strong>master nodes</strong>. The master node runs the <strong>resource manager</strong> and the <strong>scheduler</strong>&gt; and is the connection between the login node and the compute nodes. The former keeps an eye on what the compute nodes are doing and whether they are ready to accept new computational tasks. The scheduler does the planning of that work.</p>
</li>
</ul>
<p>To carry out some computational work on the compute nodes, the user must send a request to the scheduler, describing the task, the environment in which that task must be executed, and the resources (number of nodes, memory, accelerators, ...) needed by the task. Such a request is called a <strong>job script</strong> and the task is referred to as a <strong>job</strong>.</p>
<h2 id="preparing-for-the-vsc-infrastructure-in-2000wetppr">Preparing for the VSC infrastructure in 2000WETPPR</h2>
<h3 id="applying-for-a-guest-account">Applying for a guest account</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section is <strong><em>only for students of the course 2000wetppr</em></strong>.</p>
<p>Students of the course 2000wetppr must apply for a guest account to access the university's HPC clusters, unless they already have a VSC account. The project work (see <a href="evaluation">Evaluation</a>) requires access to one of the university's HPC clusters.</p>
</div>
<p>To apply for a guest account, create a SSH public/private key pair (see below) and send it by e-mail to <code>franky.backeljauw@uantwerpen.be</code> with <code>engelbert.tijskens@uantwerpen.be</code> in cc. A guest account will subsequently be created for you.</p>
<h3 id="applying-for-a-vsc-account">Applying for a VSC account</h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section is <strong><em>only for researchers of Flemish institutes</em></strong>.</p>
</div>
<p>Researchers of Flemish research institutes can apply for a VSC account to get access to the VSC Tier-2 and Tier-1 supercomputers. See <a href="https://docs.%20vscentrum.be/en/latest/access/getting_access.html">Getting access to VSC clusters</a>. An ssh public/private key pair is also required.</p>
<h3 id="creating-an-ssh-publicprivate-key-pair">Creating an ssh public/private key pair</h3>
<p>An ssh public/private key pair in necessary for both a guest account (students) and a VSC account (researchers).</p>
<p>A ssh public/private key pair is a way for secure access to a system through the Secure Shell protocol. They are basically two small files with matching numbers. You may think of the public key as a lock. Everyone is allowed to see the lock, but no one can open the lock without its key, which is the private part of the key pair. The public key (the lock) will be placed on a system you need access to, in this case the Tier-2 supercomputer of our university. To access to the supercomputer (<em>i.e.</em>, to open the lock) from, say, your laptop, you need the private key to be stored on your laptop (or a USB memory stick) and pass it to the SSH protocol, which will verify that the private key and the public key match. If case they do, the SSH protocol will open the lock and grant you access to the machine.</p>
<p>To create a ssh public/private key pair proceed as follows. Open a 'terminal'.</p>
<div class="admonition note">
<p class="admonition-title">On Windows</p>
<p>The latest builds of Windows 10 and Windows 11 include a built-in SSH server and client that are based on OpenSSH. You can use the <code>cmd</code> prompt, powershell, or WSL (Windows subsystem for Linux) as a terminal. For older Windows versions, we recommend installing <a href="https://docs.vscentrum.be/en/latest/access/access_using_mobaxterm.html#access-using-mobaxterm">mobaxterm</a> to generate a ssh public/private key pair.</p>
</div>
<div class="admonition note">
<p class="admonition-title">On Linux</p>
<p>Most Linux distributions have a <code>terminal</code> application.</p>
</div>
<div class="admonition note">
<p class="admonition-title">MacOSX</p>
<p>MacOSX comes with a build in <code>Terminal.app</code>. <code>iTerm2</code> is a replacement for <code>Terminal.app</code> with many interesting extra features.</p>
</div>
<p>Type the following command at the prompt:</p>
<pre><code class="language-shell">&gt; ssh-keygen -t rsa -b 4096
</code></pre>
<p>You will then be prompted for a file location of the public and private key. You may accept the default location by entering. The default file location will look a bit different, depending on your OS. If the files already exist you can choose to overwrite them or to cancel the operation. You might want to change the filename of the key to a more meaningfull name, <em>e.g.</em> <code>access_vaughan_rsa</code>. Don't use blanks in the filename. Use hyphens (<code>-</code>) or underscores (<code>_</code>) instead.</p>
<pre><code>Enter file in which to save the key (C:\Users\your_username/.ssh/id rsa) :
C:\Users\your_username/.ssh/id rsa already exists.
Overwrite (y/n)? y
</code></pre>
<p>You will then be prompted for a passphrase (twice). A passphrase provides an extra level of protection in case somebody would steal your private key. Press <code>enter</code> for an empty passphrase. (Passphrases are a little annoying when using VS Code (see below) for remote development.)</p>
<pre><code>Enter passphrase (empty for no passphrase):
Enter same passphrase again:
</code></pre>
<p>Finally you will be notified of where the keys are stored:  </p>
<pre><code>Your identification has been saved in C:\Users\your_username/.ssh/id rsa.
Your public key has been saved in C:\Users\your_username/.ssh/id rsa.pub.
</code></pre>
<div class="admonition note">
<p class="admonition-title">For students of 2000wetppr</p>
<p>To obtain a guest account, students must send their <strong><em>public</em></strong> key (and <strong><em>only</em></strong> the public key, the private</p>
</div>
<p>key is, well, um, <em>private</em>) to <code>franky.backeljauw@uantwerpen.be</code> with <code>engelbert.tijskens@uantwerpen.be</code> in <em>cc</em>. The public key is the one with the <code>.pub</code> extension.</p>
<h3 id="accessing-vaughan">Accessing Vaughan</h3>
<h4 id="terminal-based-access">Terminal based access</h4>
<p>Vaughan is (at the time of writing) the University of Antwerp's Tier-2 HPC cluster. For terminal based access you
open a <code>terminal</code> (see above) and execute the command:</p>
<pre><code>&gt; ssh -i path/to/my/private-ssh-key your-user-id@login1-vaughan.hpc.uantwerpen.be
Last login: Mon Feb 27 12:40:32 2023 from 143.129.75.140
--------------------------------------------------------------------
Welcome to VAUGHAN !
...
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If the key is in sub-directory <code>.ssh</code> of your home directory, the <code>-i path/to/my/private-ssh-key</code> can be omitted.</p>
</div>
<p>The <code>ssh</code> command above, connects your terminal session to a <em>login node</em> (see above) of the Vaughan cluster. 
After the command is finished, you can use the terminal as if you were working on the login node. The current working directory will be a location in your file system on the cluster, rather than on your local machine. Vaughan has two login nodes, <code>login1-vaughan.hpc.uantwerpen.be</code> and <code>login2-vaughan.hpc.uantwerpen.be</code>. You can also
use <code>login-vaughan.hpc.uantwerpen.be</code>. The system then will choose the login node with the highest availability.</p>
<p><code>Ssh</code> comes with a <code>.ssh/config</code> file that allows you to store the arguments of frequently used ssh commands. E.g.</p>
<pre><code class="language-shell"># file ~/.ssh/config
Host vn1
  HostName login1-vaughan.hpc.uantwerpen.be
  User vsc20170
  IdentityFile /full/path/to/my/private-ssh-key
  IdentitiesOnly yes
  ForwardX11 yes
  ForwardX11Trusted yes
  ServerAliveInterval 60
</code></pre>
<p>which allows to abbreviate the above <code>ssh</code> command as <code>ssh vn1</code>. The <code>config</code> file can contain several <code>Host</code> entries.</p>
<h4 id="ide-based-access">IDE based access</h4>
<p>While editing files in terminal based access is very well possible using terminal editors, e.g. <code>vim</code> or <code>nano</code>,
Many developers find code development using terminal based access rather cumbersome. IDEs (Integrated Development environment) provide a more user-friendly GUI based experience. <a href="https://visualstudio.com">Visual Studio Code</a> provides a very reasonable user experience for both local aand remote development, providing a project directory tree, an editor pane, syntax highlighting, a debugging pane, a terminal, ... It is very well suited for our project work. So, install <a href="https://visualstudio.com">Visual Studio Code</a> on your local machine. (It is available for Windows, Linux, and MacOSX).</p>
<p>Here are some useful VS Code extensions that you
should install. Click the <code>Extensions</code> icon in the activity bar on the left. You can search the Marketplace for
interesting extensions.</p>
<p><img alt="VS Code-extensions" src="../public/vscode-extensions.png"></p>
<div class="admonition tip">
<p class="admonition-title">Necessary extensions</p>
<ul>
<li>Remote Development</li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">Highly recommended extensions</p>
<ul>
<li>Python extension for Visual Studio Code</li>
<li>Python extension pack</li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">Recommended extensions for C++</p>
<ul>
<li>C/C++</li>
<li>Better C++ syntax</li>
<li>CMake</li>
<li>CMake tools</li>
</ul>
</div>
<div class="admonition tip">
<p class="admonition-title">Recommended extensions for Fortran</p>
<ul>
<li>Modern Fortran</li>
</ul>
</div>
<p>There is a helpfull tutorial on <a href="presentations/TNT-vscode.pptx">Using VS Code for Remote Development</a>, but before getting your hands dirty, please complete the steps below first.</p>
<h4 id="vs-code-fails-to-connect-due-to-file-quota-exceeded">VS Code fails to connect due to <code>file quota exceeded</code></h4>
<p>VS Code Remote installs some machinery in your home directory (<code>~/.vscode-server</code>) of the remote machine you are using. As VS Code can easily create a lot of files remotely, this can easily cause <code>file quota exceeded</code> on your <code>user</code> file system. When accessing the cluster through VS Code, you will probably only notice that VS Code fails to connect with the cluster. Log in on the cluster from a terminal with <code>ssh</code> and run  </p>
<pre><code class="language-shell">&gt; ./path/to/wetppr/scripts/mv.vscode-server.sh
</code></pre>
<p>This moves the <code>.vscode-server</code> directory from your home directory to $VSC_DATA where file quota are much larger and cannot cause problems.</p>
<h3 id="setting-up-your-remote-environment">Setting up your remote environment</h3>
<h4 id="lmod-modules">LMOD modules</h4>
<p>A HPC cluster provides you with many installed software packages. However, none of them are immediately available. To make a package available, you must <code>load</code> the corresponding software module. (These modules, also known as <strong>LMOD modules</strong>, are a different <em>module</em> kind than the Python modules). In the project directory <code>scripts/vaughan/</code> you find a script <code>env-lmod.sh</code> that can be sourced to load a set of commonly used LMOD modules in this course.  Additional modules can be loaded as <code>module load &lt;module-name&gt;</code>, or the shorthand <code>ml &lt;module-name&gt;</code> . Sourcing a script differs from executing it in that it modifies the current environment (<a href="https://superuser.com/questions/176783/what-is-the-difference-between-executing-a-bash-script-vs-sourcing-it">see _e.g. this</a>). A script is sourced through the <strong>source</strong> command:</p>
<pre><code class="language-shell">&gt; cd path/to/wetppr 
&gt; source scripts/vaughan/env-lmod.sh
Using toolchain_name foss/2022a 

module load calcua/2022a
module load foss
module load SciPy-bundle
module load numba
wip-tools dependencies:
module load CMake
module load git
module load gh
</code></pre>
<p>The <code>env-lmod.sh</code> script can be used to load the modules for different toolchains and versions:</p>
<pre><code class="language-shell">&gt; source scripts/vaughan/env-lmod.sh intel # =&gt; intel/2022a
&gt; source  scripts/vaughan/env-lmod.sh foss/2023a # =&gt; foss/2022a
</code></pre>
<p>The <strong>foss</strong> toolchain uses the GCC compilers to build software, whereas the <strong>intel</strong> toolchain uses the Intel compilers.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>The <code>source</code> command can be abbreviated as <code>.</code>.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Sourcing a script modifies your environment for the time of your shell session. Every time you start a new shell session, you must reload these modules. Initially, it might be tempting to source the script in your <code>.bashrc</code>. However, soon you will discover that such scripts depend on the project you are working on, and that it is better to have it somewhere in your project directory.</p>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In order to be able to execute a shell script, it must be made <strong>executable</strong> (<code>chmod +x &lt;path/to/script&gt;</code>). Shell scripts that intend to modify the environment, like <code>env-lmod.sh</code>, and thus must be sourced, need not be executable. If you do not make the script executable, it can only be sourced. In this way you avoid the surprises from an unmodified environment after executing a script that expect to be sourced. (There are also [tricks to detect if a script is being sourced(https://stackoverflow.com/questions/2683279/how-to-detect-if-a-script-is-being-sourced)] or not.)</p>
</div>
<h4 id="wiptools">Wiptools</h4>
<p><a href="https://etijskens.github.io/wiptools">Wiptools</a> is a Python package that can simplify your project management considerably. If you haven't already done so, source the <code>env-lmod.sh</code> script  above and install wip-tools in a (remote) terminal as:</p>
<pre><code class="language-shell">&gt; pip install --user wiptools
...
</code></pre>
<p>If you are interested in building binary extension modules from C++, you should also install <code>nanobind</code></p>
<pre><code class="language-shell">&gt; pip install --user nanobind
...
</code></pre>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code>--user</code> flag instructs <code>pip</code> to install the package in the directory defined by the environment variable <code>${PYTHONUSERBASE}</code>. The default install path of <code>pip</code> is a system location for which you do not have write permissions. Omitting <code>--user</code> would raise a <code>PermissionError</code>. When installing on your local machine, the <code>--user</code> flag may be omitted.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Before starting to use <code>wiptools</code>, checkout these <a href="https://etijskens.github.io/wiptools/installation/#prerequisites">prerequisites</a>.</p>
</div>
<h2 id="submitting-jobs-on-vaughan">Submitting jobs on Vaughan</h2>
<p>Unlike your personal computer, which you use mainly <strong>interactively</strong>, a supercomputer is mostly used in <strong>batch mode</strong>. To execute some computational work, you send a request to the <strong>scheduler</strong> specifying the work and how you want it to be executed. You must specify</p>
<ul>
<li>
<p>the resources you need,</p>
</li>
<li>
<p>how the environment must be set up, <em>i.e.</em> necessary LMOD modules and environment variables, and</p>
</li>
<li>
<p>the command(s) you want to execute.</p>
</li>
</ul>
<p>Such a request is called a <strong>job script</strong>. The scheduler decides which compute nodes will be used for your job and when it will be started, based on a fair share policy and the availability of the resources of the cluster. </p>
<p>Most modern supercomputers - all VSC clusters - use <a href="https://slurm.schedmd.com">Slurm</a> for resource management and scheduling. An extensive description about using Slurm on Vaughan can be found <a href="https://calcua.uantwerpen.be/courses/hpc-intro/IntroductionHPC-20230313.pdf">here</a>.</p>
<p>Here is a simple job script, annotated with explanations for each line:</p>
<pre><code class="language-shell">&lt;!-- BEGIN INCLUDE ../scripts/vaughan/hello-mpi4py/hello-mpi4py.slurm --&gt;
#!/bin/bash
### The line above is the shebang. It specifies the interpreter for the script. 
### (see https://linuxhandbook.com/shebang/). Always /bin/bash for job scripts.

### Submit this job from the parent directory as:
### &gt; cd path/to/wetppr/scripts/vaughan/hello-mpi4py
### &gt; sbatch hello-mpi4py.slurm

### Slurm job script parameters ################################################
### Accounting info. Specify the account from which credits will be taken to 
### execute this job. At the time of writing (11/2023) only applicable on 
### the VSC Tier-1 computer Hortense and the Tier-2 supercomputers at KU Leuven,
### soon also in Tier-2 supercomputers at UAntwerpen. 
### SBATCH --account=&lt;account-name&gt;

### Specify the job name
#SBATCH --job-name hello-mpi4py

### Redirect output written to stdout to file &lt;job-name&gt;.&lt;job-id&gt;.stdout 
### Redirect output written to stderr to file &lt;job-name&gt;.&lt;job-id&gt;.stderr
### This groups your files nicely in a alphabetical listing.
#SBATCH -o %x.%j.stdout
#SBATCH -e %x.%j.stderr

### Slurm resource specifications 
### Request 1 compute node
#SBATCH --nodes=1

### Request 16 MPI processes
#SBATCH --ntasks=16 

### Request 1 CPU per MPI process (no hybrid OpenMP-MPI)
#SBATCH --cpus-per-task=1

### Tell Slurm that you expect the job to end in 5 minutes.
### (Abort the job if it takes longer).
#SBATCH --time=00:05:00

### Prepare the environment for the job ########################################
### Source the env-lmod.sh script to loads the LMOD modules needed.
### We request it to use the foss toolchain. 
source ../env-lmod.sh foss

### Specify the computational work #############################################
### Run the Python script hello-mpi4py.py on the requested resources by calling 
### srun (this is a Slurm command)
srun -n${SLURM_NTASKS} -c${SLURM_CPUS_PER_TASK} --exclusive --unbuffered python hello-mpi4py.py
&lt;!-- END INCLUDE --&gt;
</code></pre>
<p>This job script reqests the parallel execution of a simple Python script <code>hello-mpi4py.py</code> that prints some environment variables set by Slurm, and a line for each MPI process with some info about the MPI process:</p>
<pre><code class="language-python">&lt;!-- BEGIN INCLUDE ../scripts/vaughan/hello-mpi4py/hello-mpi4py.py --&gt;
import os
jobid  = os.getenv('SLURM_JOB_ID')
stepid = os.getenv('SLURM_STEP_ID')
pid    = os.getpid()
affinity = os.sched_getaffinity(0) # set of the CPUs used by the current MPI proces

from mpi4py import MPI
comm = MPI.COMM_WORLD


def print_environment_variable(name):
    """Print the name and the value of an environment value."""
    value = os.getenv(name)
    print(f"${{{name}}}={value}")


if __name__ == '__main__':
    # Print some environment variables (only if the MPI rank is 0)
    if comm.rank == 0:
        print_environment_variable('SLURM_NTASKS')
        print_environment_variable('SLURM_CPUS_PER_TASK')

    # Print a line with the job-id, job-step-id, MPI rank, total number of MPI
    # processes, process id, and the affinity (the id of the CPU on which 
    # the MPI process is running). Every MPI process will print one line.
    print(f'jobid.stepid={jobid}.{stepid}, MPI_rank={comm.rank}/{comm.size}, {pid=} : affinity={affinity}')

&lt;!-- END INCLUDE --&gt;
</code></pre>
<p>The job is submitted from the login node as:</p>
<pre><code class="language-shell">&gt; cd path/to/wetppr/scripts/vaughan/hello-mpi4py
&gt; sbatch mpi4py_hello_world.slurm
</code></pre>
<p>Note that we first cd into the parent directory of the job script because the job script uses paths relative to the parent directory ()<code>../env-lmod.sh</code> and <code>hello-mpi4py.py</code>). If all goes well, <code>sbatch</code> responds with something like:</p>
<pre><code class="language-shell">Submitted batch job 1186356
</code></pre>
<p>Where <code>1186356</code> is the job-id. </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>If something goes wrong with the job and you need help from the system administrator, always mention the job-id.</p>
</div>
<p>The job is now in the job queue. You can check the status of all your submitted jobs with the <code>squeue</code> command:</p>
<pre><code class="language-shell">&gt; squeue
             JOBID PARTITION     NAME     USER ST       TIME  NODES NODELIST(REASON)
           1186356      zen2 hello-mp vsc20170 PD       0:00      2 (Priority)
</code></pre>
<p>The <code>ST</code> column shows the status of your job. <code>PD</code> means 'pending', the job is waiting for resource allocation. It will eventually run. Once running, it will show <code>R</code> as a status code and the <code>TIME</code> column will show the walltime of the job. Once completed the status will be 'CD' and after some minutes, it will disappear from the output of the <code>squeue</code> command. The directory <code>wetppr/scripts/vaughan_examples</code> now contains two extra files:</p>
<pre><code class="language-shell">&gt; ls -l
-rw-rw-r-- 1 vsc20170 vsc20170    0 Oct 26 09:32 hello-mpi4py.1186356.stderr
-rw-rw-r-- 1 vsc20170 vsc20170 1306 Oct 26 09:43 hello-mpi4py.1186356.stdout
-rw-rw-r-- 1 vsc20170 vsc20170  973 Oct 26 09:42 hello-mpi4py.py
-rw-rw-r-- 1 vsc20170 vsc20170 1826 Oct 26 08:56 hello-mpi4py.slurm
</code></pre>
<p>The job has created two output files with the output written to stderr and stdout, respectively. As requested by the job script lines <code>#SBATCH -o %x.%j.stdout</code> and <code>#SBATCH -e %x.%j.stderr</code>, they are compose as <code>&lt;job-name&gt;.&lt;job-id&gt;.stdout</code> and <code>&lt;job-name&gt;.&lt;job-id&gt;.stderr</code>, respectively. Error messages are normally written to the <code>stderr</code> file, which is empty in this case, as indicated by the 0 file size. The output of the Python script <code>hello-mpi4py.py</code> appears in <code>hello-mpi4py.1186356.stdout</code>, as well as that of <code>env-lmod.sh</code>, which precedes that of <code>hello-mpi4py.py</code> .</p>
<pre><code class="language-shell">&lt;!-- BEGIN INCLUDE ../scripts/vaughan/hello-mpi4py/hello-mpi4py.1186356.stdout_ok --&gt;

Using toolchain_name foss/2022a 

module load calcua/2022a
module load foss
module load SciPy-bundle
module load numba
wip-tools dependencies:
module load CMake
module load git
module load gh

${SLURM_NTASKS}=16
${SLURM_CPUS_PER_TASK}=1
jobid.stepid=1186356.0, MPI_rank=0/16, pid=1489956 : affinity={0}
jobid.stepid=1186356.0, MPI_rank=1/16, pid=1489957 : affinity={1}
jobid.stepid=1186356.0, MPI_rank=2/16, pid=1489958 : affinity={2}
jobid.stepid=1186356.0, MPI_rank=3/16, pid=1489959 : affinity={3}
jobid.stepid=1186356.0, MPI_rank=4/16, pid=1489960 : affinity={4}
jobid.stepid=1186356.0, MPI_rank=5/16, pid=1489961 : affinity={5}
jobid.stepid=1186356.0, MPI_rank=6/16, pid=1489962 : affinity={6}
jobid.stepid=1186356.0, MPI_rank=7/16, pid=1489963 : affinity={7}
jobid.stepid=1186356.0, MPI_rank=8/16, pid=1489964 : affinity={8}
jobid.stepid=1186356.0, MPI_rank=9/16, pid=1489965 : affinity={9}
jobid.stepid=1186356.0, MPI_rank=10/16, pid=1489966 : affinity={10}
jobid.stepid=1186356.0, MPI_rank=11/16, pid=1489967 : affinity={11}
jobid.stepid=1186356.0, MPI_rank=12/16, pid=1489968 : affinity={12}
jobid.stepid=1186356.0, MPI_rank=13/16, pid=1489969 : affinity={13}
jobid.stepid=1186356.0, MPI_rank=14/16, pid=1489970 : affinity={14}
jobid.stepid=1186356.0, MPI_rank=15/16, pid=1489971 : affinity={15}

&lt;!-- END INCLUDE --&gt;
</code></pre>
<p>We already explained the job-id. The step-id is tied to an individual srun command. The job script has only one srun command, so the step-id is always 0 (counting starts at 0, in C/C++/Python tradition). The MPI rank is tied to he MPI process running. The job script requested <code>#SBATCH --ntasks=16</code>, hence, the MPI rank ranges from 0 to 15. Pid is the process id. It refers to the Linux process of the given MPI rank. Finally, affinity is the set of CPUs on which the process runs. Since the job script requested <code>#SBATCH --cpus-per-task=1</code>, each MPI rank uses only a single CPU. In hybrid MPI-OpenMP programs, an MPI rank can use OpenMP parallel sections over several CPUs. In that case one would request, <em>e.g.</em>, <code>#SBATCH --cpus-per-task=4</code> and the afinity sets would show 4 different CPUs.</p>
<p>The job above requested only a single compute node and a very short wall time (5'). Often, it will start executing allmost immediately after submitting. For larger jobs, requiring many nodes, the scheduler has to find a moment at which the number of nodes requested are available (that is, without work load). Typically, one has to wait a bit before the job starts.  The waiting time depends on the total work load of the cluster, but rarely exceeds more than a day. To know when your job starts and ends, you can ask the scheduler to send you an e-mail, by adding these lines to your job script:</p>
<pre><code class="language-shell">### Send mail when the job starts, ands and fails 
#SBATCH --mail-type=BEGIN,END,FAIL
### Send mail to this address:
#SBATCH -â€“mail-user=&lt;your e-mail address&gt;
</code></pre>
<p>Note that the maximum wall time for a job is 72 hours. Longer jobs must be split into pieces shorter than 72 hours. Jobs of 1 hour or less have higher priority.</p>
<h1 id="recommended-steps-from-here">Recommended steps from here</h1>
<ul>
<li>A helpfull tutorial on <a href="presentations/TNT-vscode.pptx">Using VS Code for Remote Development</a></li>
<li>The <a href="">Getting started with wip</a></li>
</ul></div></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS_HTML" defer></script>
        <script src="../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
