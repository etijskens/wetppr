
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../chapter-2/">
      
      
        <link rel="next" href="../evaluation/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.0.10">
    
    
      
        <title>Chapter 3 - When to parallelize, and what to do first ... - Parallel programmeren</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.0d440cfe.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.2505c338.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../css/extra.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#chapter-3-when-to-parallelize-and-what-to-do-first" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Parallel programmeren" class="md-header__button md-logo" aria-label="Parallel programmeren" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Parallel programmeren
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapter 3 - When to parallelize, and what to do first ...
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Parallel programmeren" class="md-nav__button md-logo" aria-label="Parallel programmeren" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Parallel programmeren
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Welkom bij Parallel programmeren
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../over-de-auteur/" class="md-nav__link">
        Over de auteur
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../overview/" class="md-nav__link">
        Overview
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chapter-1/" class="md-nav__link">
        Chapter 1 - Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chapter-2/" class="md-nav__link">
        Chapter 2 - Aspects of modern CPU architecture
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Chapter 3 - When to parallelize, and what to do first ...
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Chapter 3 - When to parallelize, and what to do first ...
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#common-sense-optimisations" class="md-nav__link">
    Common sense optimisations
  </a>
  
    <nav class="md-nav" aria-label="Common sense optimisations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-magnetization-of-bulk-ferromagnets" class="md-nav__link">
    1. Magnetization of bulk ferromagnets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-transforming-the-problem-domain" class="md-nav__link">
    2. Transforming the problem domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-transforming-data-to-reduce-their-memory-footprint" class="md-nav__link">
    3. Transforming data to reduce their memory footprint
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-optimisations" class="md-nav__link">
    Code optimisations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-approaches-towards-parallelization" class="md-nav__link">
    Common approaches towards parallelization
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../evaluation/" class="md-nav__link">
        Evaluation
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../assignment/" class="md-nav__link">
        Assignment 2022-23
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../guide-lines/" class="md-nav__link">
        Assignment guide lines
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#common-sense-optimisations" class="md-nav__link">
    Common sense optimisations
  </a>
  
    <nav class="md-nav" aria-label="Common sense optimisations">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-magnetization-of-bulk-ferromagnets" class="md-nav__link">
    1. Magnetization of bulk ferromagnets
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-transforming-the-problem-domain" class="md-nav__link">
    2. Transforming the problem domain
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-transforming-data-to-reduce-their-memory-footprint" class="md-nav__link">
    3. Transforming data to reduce their memory footprint
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-optimisations" class="md-nav__link">
    Code optimisations
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#common-approaches-towards-parallelization" class="md-nav__link">
    Common approaches towards parallelization
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="chapter-3-when-to-parallelize-and-what-to-do-first">Chapter 3 - When to parallelize, and what to do first ...</h1>
<p>When your program takes too long, the memory of your machine is too small for your problem or the accuracy you need 
cannot be met, you're hitting the wall. Parallelization seems necessary, and you feel in need of a supercomputer.
However, supercomputers are expensive machines and resources are limited. It should come to no surprise that it is 
expected that programs are allowed to run on supercomputers only if they make efficient use of their resources. 
Often, serial programs provide possibilities to improve the performance. These come in two categories: <strong>common sense 
optimisations</strong> (often completely overlooked by researchers) which rely on a good understanding of the mathematical 
formulation of the problem and the algorithm, and <strong>code optimisations</strong> which rely on understanding processor 
architecture and compilers. Lets first look at common sense optimisations. </p>
<h2 id="common-sense-optimisations">Common sense optimisations</h2>
<p>Common sense optimizations come from a good understanding of the mathematical formulation of the problem and seeing 
opportunities to reduce the amount of work. We give three examples. </p>
<h3 id="1-magnetization-of-bulk-ferromagnets">1. Magnetization of bulk ferromagnets</h3>
<p>I was asked to speed up a program for computing the magnetisation $m(T)$ of bulk ferromagnets as a function of 
temperature $T$. This is given by a self-consistent solution of the equations:</p>
<p>$$ m = \frac{1}{2 + 4\Phi(m)} $$</p>
<p>$$ \Phi(m) = \frac{1}{N} \sum_{\textbf{k}} \frac{1}{e^{\beta\eta(\textbf{k})m} - 1} $$</p>
<p>with $ \beta = 1/{k_B T} $. At $T=0$ we have $m(0) = m_0 = 0.5$, and at high $T$, $m(T)$ approaches zero.</p>
<p>The solution is a curve like this:</p>
<p><img alt="m(T)" src="/public/m(T).png" /></p>
<p>The program compute this as follows: For any temperature $T$, set $m = m_0$ as an inital guess. Then iterate $ m_
{i+1} = 1/(2 + 4\Phi(m_i)) $ until $ \Delta m = m_{i+1} - m_i $ is small. Here,</p>
<p>$$ \Phi(m) = \sum_{n=1}^\infty \frac{a}{\pi} \left(\int_0^{\pi/a} dq e^{-nm\beta\eta_1(q)}\right)^3 $$</p>
<p>and the integral is computed using Gauss-Legendre integration on 64 points.  </p>
<p>The choice of $m=0.5$ as initial guess is obviously a good one close to $T=0$. However, looking at the graph above, 
it becomes clear that as T increases the solution moves further and further away from $0.5$. Furthermore, if we 
compute tempurature points at equidistant tempurature points, $T_j = \delta j$ for some $\delta$ and $j=0,1,2, .
..$, it is also clear that the solution of the previous temperature point, <em>i.e.</em> $m_{j-1}, is a far better initial 
initial guess 
guess than $m_0$. This turns out to be 1.4x faster. Not a tremendous improvement, as the graph above seems continuous 
we can take this idea a step further: using interpolation from solutions a lower temperature points to predict the 
next solution and use that as an initial guess. Linear interpolation of $m_j$ from $m_{j-1}$ and $m_{j-2}$ gives a 
a speedup of 1.94x and quadratic interpolation from  $m_{j-1}$, $m_{j-2}$ and $m_{j-3}$ a factor of 2.4x. That is a 
substantial speedup achieved without acttually modifying the code. This optimisation comes entirely from 
understanding what your algorithm actually does. Investigation of the code itself demonstrated that it made suffered 
from a lot of dynamic memory management and that it did not vectorize. After fixing these issues, the code ran an 
additional 13.6x faster. In total the code was sped up by an impressive 32.6x.</p>
<h3 id="2-transforming-the-problem-domain">2. Transforming the problem domain</h3>
<p>At another occasion I had to investigate a code for calculating a complicated sum of integrals in real space. After 
fixing some bugs and some optimisation to improve the efficiency, it was still rather slow because the formula 
converged slowly  As the code was running almost at peak performance, so there was little room for improvement. 
However, at some point we tried to apply the Fourier transform to get an expression in frequency space. This 
expression turned out to converge much faster and consequently far less terms had to be computed, yielding a speedup 
of almost 2 orders of magnitude and was much more accurate. This is another example of common sense optimisation 
originating in a good mathematical background. The natural formulation of a problem is not necessarily the best to 
use for computation.    </p>
<h3 id="3-transforming-data-to-reduce-their-memory-footprint">3. Transforming data to reduce their memory footprint</h3>
<p>I recently reviewed a Python code by the Vlaamse Milieumaatschappij for modelling the migration of invertebrate aquatic 
species in response to improving (or deteriorating) water quality. The program read a lot data from .csv files. For 
a project it was necessary to run a parameter optimisation. That is a procedure where model parameters are varied 
until the outcome is satisfactory. If the number of model parameters is large the number of program runs required can 
easily reach in the 100 000s. The program was parallellized on a single node. However, the program was using that many 
data that 18 cores of the 128 cores available on a node already consumed all the available memory. By replacing the 
data types of the columns of the datasets with datatypes with a smaller footprint, such as replacing categorical data 
with integer IDs, replacing 32-bit integers with 16-bit or even 8-bit integers, float64 real numbers with float32 or 
float16 numbers reduced the amount of data used by a factor 8. All of a sudden much more cores could be engaged in 
the computation and the simulation sped up considerably.   </p>
<p>Some of these "common sense optimisations" may seem obvious. Yet, of all the codes I reviewed during my career, few 
of them were immune to common sense optimisation. Perhaps, developing (scientific) software takes a special mindset: </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>The scientific software developer mindset</strong>: Constantly ask yourself 'How can I improve this? How can I make 
it faster, leaner, more readable, more flexible, more reusable, ... ?'</p>
</div>
<p>Common sense optimisations are optimisations that in general don't require complex code analysis, require very little 
code changes and thus little effort to implement them. Yet they can make a significant contribution.</p>
<h2 id="code-optimisations">Code optimisations</h2>
<p>Code optimisations are optimisations aiming at making your solution method run as efficient as possible on the 
machine(s) that you have at your disposal. This is sometimes referred as <strong>code modernisation</strong>, because code that 
was optimised for the CPUs of two years a go may well need some revision for the latest CPU technology. These 
optimisations must, necessarily, take in account the specific processor architecture of your machine(s). Important 
topics are: </p>
<ul>
<li>Avoid pipeline stalls (due to impredictable branches, <em>e.g.</em>) </li>
<li>Ensure SIMD vectorisation. On modern processors vector registers can contain 4 double precision floating point 
  numbers or 8 single precision numbers and vector instructions operate on these in the same number of cycles as 
  scalar instructions. Failing to vectorise can reduce the speed of your program by a factor up to 8x!   </li>
<li>Smart data access patterns are indispensable for programs with a memory footprint that exceeds the size of the cache. 
  Transferring data from main memory (DRAM) to the processor's registers is slow: typical latencies are in the order 
  of 100 cycles (which potentially wastes ~800 single precision vectorised operations). Vector instructions are of 
  no help if the processing unit must wait for the data. </li>
</ul>
<p>This is clearly much more technical and complicated (in the sense that it requires knowledge from outside the 
scientific domain of the problem you are trying to solve). Especially fixing memory access patterns can be difficult 
and a lot ofwork, as you may have to change the data structures used by your program, which usually also means 
rewriting a lot of code accessing the data. Such code optimisations can contribute significantly to the performance 
of a program, typically around 5-10x, but possibly more. As supercomputers are expensive research infrastructure in 
high demand, we cannot effort to waste resources. That being said, the lifetime of your program is also of 
importance. If you are developing a code that will be run a few times during your Master project or PhD, using only 
a hundred of node days, and to be forgotten afterwards, it is perhaps not worth to spend 3 months optimising it.</p>
<p>Often, however, there is a way around these technicalities. If the scientific problem you are trying to solve, can 
be expressed in the formalism of common mathematical domains, <em>e.g.</em> linear algebra, Fourier analysis, ..., there is 
a good chance that there are good software libraries, designed with HPC in mind, that solved these problems for you. 
In most cases there are even bindings available for your favorite progamming language (C/C++, Fortran, Python, ...).<br />
All you have to do is translate the mathematical formulation of your problem into library calls. </p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p><strong>Use HPC libraries as much as possible</strong>. There is little chance that you will outperform them. Quite to the 
contrary: your own code will probably do significantly worse. By using HPC libraries you gain three times:</p>
<ul>
<li>you gain performance,</li>
<li>you gain development time as you will need a lot less code to solve your problem, less debugging, simpler 
  maintenance, ...</li>
<li>your learn how to use the library which will get you at speed readily when you take on your next 
  scientific problem.</li>
</ul>
</div>
<h2 id="common-approaches-towards-parallelization">Common approaches towards parallelization</h2>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.db81ec45.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.6df46069.min.js"></script>
      
    
  </body>
</html>